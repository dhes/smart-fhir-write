<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Example SMART App</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <style>
      /* #patient,
      #meds {
        font-family: Monaco, monospace;
        white-space: pre;
        font-size: 13px;
        height: 30vh;
        overflow: scroll;
        border: 1px solid #ccc;
      } */
    </style>
  </head>
  <body>
    <pre></pre>
    <!-- h4 --> <!-- Current Patient --><!-- /h4 -->
    <!-- div id="patient" --><!-- Loading... --><!-- /div -->
    <!-- this form is from https://www.dyn-web.com/tutorials/forms/radio/get-selected.php DH -->
    <form action="#" method="post" class="raceForm" id="raceForm">
      <fieldset>
        <legend id="pt"> <b>Loading...</b>b></legend>

        <p>Select 'race':</p>
        <p>
          <label
            ><input type="radio" name="race" value="black" checked /> African American (Black)</label
          ></br>
          <label
            ><input type="radio" name="race" value="white" /> European American (White)</label
          ></br>
          <label
            ><input type="radio" name="race" value="other" /> Other </label
          >
        </p>

        <p>
          <button type="button" name="getVal">Done</button><button type="button" onClick="window.self.close()"><b>Cancel</b></button>
        </p>
      </fieldset>
    </form>
    <script>
      "use strict";
      FHIR.oauth2
        .ready()
        .then(function (smart) {
          //   // Create the patient and then update its active flag to "true"
          //   // smart.api.create({resource: resource}).then(function(r) {
          //   smart.create(resource).then(function (r) {
          //     // NOTE that the patient will now have new "id" assigned by the
          //     // server. The next request will be PUT (update) and that id will
          //     // be required...
          //     // var patient = r.data;
          //     var patient = r;
          //     patient["active"] = true;
          //     // smart.api.update({resource: patient}).then(function(r) {
          //     smart.update(patient).then(function (r) {
          //       var out = JSON.stringify(r, null, "   ");
          //       document.getElementsByTagName("pre")[0].innerText =
          //         "Now " +
          //         "we have the following patient in the FHIR server:\n\n" +
          //         out;
          //     });
          //   });
          // Render the current patient (or any error)
          smart.patient.read().then(
            function (pt) {
              // document.getElementById("patient").innerText = JSON.stringify(
              //   pt,
              //   null,
              //   4
              // );
              console.dir(pt);
              document.getElementById("pt").innerText =
                pt.name[0].given[0] +
                " " +
                pt.name[0].family +
                " ID: " +
                pt.id +
                " ";
              // var resource = {
              //   resourceType: "Observation",
              //   status: "final",
              //   category: [
              //     {
              //       coding: [
              //         {
              //           system:
              //             "http://terminology.hl7.org/CodeSystem/observation-category",
              //           code: "social-history",
              //           display: "Social History",
              //         },
              //       ],
              //       text: "Social History",
              //     },
              //   ],
              //   code: {
              //     coding: [
              //       {
              //         system: "http://loinc.org",
              //         code: "79423-0",
              //         display:
              //           "Cardiovascular disease 10Y risk [Likelihood] ACC-AHA Pooled Cohort by Goff 2013",
              //       },
              //     ],
              //     text: "Cardiovascular disease 10Y risk [Likelihood] ACC-AHA Pooled Cohort by Goff 2013",
              //   },
              //   valueQuantity: {
              //     value: 15.1,
              //     unit: "%",
              //     system: "http://unitsofmeasure.org",
              //     code: "%",
              //   },
              //   effectiveDateTime: "2021-04-05T00:00:00.000Z",
              // };

              // // TODO
              // // server will set resource id
              // // need to obtain patient id and add subject reference i.e.
              // // subject: {
              // //     reference: "Patient/a6c7f012-0b32-4048-8c8b-27d2763b8cdc",
              // //   },
              // // need to add "issued": Now()

              // resource["subject"] = {
              //   reference: "Patient/" + pt.id,
              // };
              // smart.create(resource);
              // DH
              // here are the top level categories
              // 2054-5	Black or African American
              // 2028-9	Asian
              // 2076-8	Native Hawaiian or Other Pacific Islander
              // 2106-3	White
              // 1002-5	American Indian or Alaska Native
              // see https://www.hl7.org/fhir/v3/Race/cs.html
              // e.g. white:
              // let white = [
              //   {
              //     url: "http://hl7.org/fhir/StructureDefinition/us-core-race",
              //     valueCodeableConcept: {
              //       coding: [
              //         {
              //           system: "http://hl7.org/fhir/v3/Race",
              //           code: "2106-3",
              //           display: "White",
              //         },
              //       ],
              //     },
              //   },
              // ];
              let ethnicityExample = [
                {
                  extension: [
                    {
                      url: "ombCategory",
                      valueCoding: {
                        system: "urn:oid:2.16.840.1.113883.6.238",
                        code: "2135-2",
                        display: "Hispanic or Latino",
                      },
                    },
                    {
                      url: "detailed",
                      valueCoding: {
                        system: "urn:oid:2.16.840.1.113883.6.238",
                        code: "2184-0",
                        display: "Dominican",
                      },
                    },
                    {
                      url: "detailed",
                      valueCoding: {
                        system: "urn:oid:2.16.840.1.113883.6.238",
                        code: "2148-5",
                        display: "Mexican",
                      },
                    },
                    {
                      url: "text",
                      valueString: "Hispanic or Latino",
                    },
                  ],
                  url: "http://hl7.org/fhir/us/core/StructureDefinition/us-core-ethnicity",
                },
              ];
              let mixedRaceExample = [
                {
                  url: "http://hl7.org/fhir/us/core/StructureDefinition/us-core-race",
                  extension: [
                    {
                      url: "ombCategory",
                      valueCoding: {
                        system: "urn:oid:2.16.840.1.113883.6.238",
                        code: "2106-3",
                        display: "White",
                      },
                    },
                    {
                      url: "ombCategory",
                      valueCoding: {
                        system: "urn:oid:2.16.840.1.113883.6.238",
                        code: "1002-5",
                        display: "American Indian or Alaska Native",
                      },
                    },
                    {
                      url: "ombCategory",
                      valueCoding: {
                        system: "urn:oid:2.16.840.1.113883.6.238",
                        code: "2028-9",
                        display: "Asian",
                      },
                    },
                    {
                      url: "detailed",
                      valueCoding: {
                        system: "urn:oid:2.16.840.1.113883.6.238",
                        code: "1586-7",
                        display: "Shoshone",
                      },
                    },
                    {
                      url: "detailed",
                      valueCoding: {
                        system: "urn:oid:2.16.840.1.113883.6.238",
                        code: "2036-2",
                        display: "Filipino",
                      },
                    },
                    {
                      url: "text",
                      valueString: "Mixed",
                    },
                  ],
                },
              ];
              // console.dir(pt["extension"][0].url);
              let usCoreRaceUrl =
                "http://hl7.org/fhir/us/core/StructureDefinition/us-core-race";
              let extensionUsCoreRaceEntry = mixedRaceExample.find(
                (element) => element.url === usCoreRaceUrl
              );
              console.log(extensionUsCoreRaceEntry);
              console.log("race example: ");
              console.log(extensionUsCoreRaceEntry != undefined);
              extensionUsCoreRaceEntry = ethnicityExample.find(
                (element) => element.url === usCoreRaceUrl
              );
              // console.log("ethnicity example: ");
              // console.log(extensionUsCoreRaceEntry != undefined);
              // console.dir(pt["extension"]);
              // console.log("is there an extension alread? ")
              // console.log(pt["extension"]!= undefined);
              let femaleAtBirth = {
                url: "http://hl7.org/fhir/us/core/StructureDefinition/us-core-birthsex",
                valueCode: "F",
              };
              let whiteRace = {
                url: "http://hl7.org/fhir/us/core/StructureDefinition/us-core-race",
                extension: [
                  {
                    url: "ombCategory",
                    valueCoding: {
                      system: "urn:oid:2.16.840.1.113883.6.238",
                      code: "2106-3",
                      display: "White",
                    },
                  },
                  {
                    url: "text",
                    valueString: "White",
                  },
                ],
              };
              // use this to add a female-at-birth extension for testing purposes  // DH
              // if (pt.hasOwnProperty("extension")) {
              //   console.log("this patient resource has an extension");
              //   pt["extension"].push(femaleAtBirth);
              // } else {
              //   console.log("this patient resource does not have an extension");
              //   pt["extension"] = [femaleAtBirth];
              // end
              // this is the actual code:
              if (pt.hasOwnProperty("extension")) {
                console.log("this patient resource has an extension");
                pt["extension"].push(whiteRace);
              } else {
                console.log("this patient resource does not have an extension");
                pt["extension"] = [whiteRace];
                // end
                // or
                // pt["extension"] = [];
                // pt["extension"].push(white);
              }
              // smart.update(pt); DH
              // pt["extension"] = white;
              // console.dir(pt);
              // smart.update(pt);
            },
            function (error) {
              document.getElementById("pt").innerText = error.stack;
            }
          );
        })
        .catch(console.error);
      // DH this form code is from https://www.dyn-web.com/tutorials/forms/radio/get-selected.php
      function getRadioVal(form, name) {
        var val;
        // get list of radio buttons with specified name
        var radios = form.elements[name];

        // loop through list of radio buttons
        for (var i = 0, len = radios.length; i < len; i++) {
          if (radios[i].checked) {
            // radio checked?
            val = radios[i].value; // if so, hold its value in val
            break; // and break out of for loop
          }
        }
        return val; // return value of checked radio or undefined if none checked
      }
      // get value of selected 'race' radio button in 'raceForm'
      var val = getRadioVal(document.getElementById("raceForm"), "race");
      //alert(val);
    </script>
  </body>
</html>
