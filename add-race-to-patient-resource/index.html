<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Example SMART App</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
  </head>
  <body>
    <pre></pre>
    <!-- this form is from https://www.dyn-web.com/tutorials/forms/radio/get-selected.php DH -->
    <form action="#" method="post" class="raceForm" id="raceForm" onsubmit="getRadioVal(this.class, this.name);">
      <fieldset>
        <legend id="pt"> <b>Loading...</b></legend>

        <p>Select 'race':</p>
        <p>
          <label
            ><input type="radio" name="race" value="black" checked /> African American (Black)</label
          ></br>
          <label
            ><input type="radio" name="race" value="white" /> European American (White)</label
          ></br>
          <label
            ><input type="radio" name="race" value="other" /> Other </label
          >
        </p>

        <p>
          <button type="submit" name="getVal">Submit</button><button type="button" onClick="window.self.close()">Cancel</button>
        </p>
      </fieldset>
    </form>
    <script>
      "use strict";
      FHIR.oauth2
        .ready()
        .then(function (smart) {
          // Render the current patient (or any error)
          smart.patient.read().then(
            function (pt) {
              console.dir(pt);
              document.getElementById("pt").innerText =
                pt.name[0].given[0] +
                " " +
                pt.name[0].family +
                " ID: " +
                pt.id +
                " ";
              let ethnicityExample = [
                {
                  extension: [
                    {
                      url: "ombCategory",
                      valueCoding: {
                        system: "urn:oid:2.16.840.1.113883.6.238",
                        code: "2135-2",
                        display: "Hispanic or Latino",
                      },
                    },
                    {
                      url: "detailed",
                      valueCoding: {
                        system: "urn:oid:2.16.840.1.113883.6.238",
                        code: "2184-0",
                        display: "Dominican",
                      },
                    },
                    {
                      url: "detailed",
                      valueCoding: {
                        system: "urn:oid:2.16.840.1.113883.6.238",
                        code: "2148-5",
                        display: "Mexican",
                      },
                    },
                    {
                      url: "text",
                      valueString: "Hispanic or Latino",
                    },
                  ],
                  url: "http://hl7.org/fhir/us/core/StructureDefinition/us-core-ethnicity",
                },
              ];
              let mixedRaceExample = [
                {
                  url: "http://hl7.org/fhir/us/core/StructureDefinition/us-core-race",
                  extension: [
                    {
                      url: "ombCategory",
                      valueCoding: {
                        system: "urn:oid:2.16.840.1.113883.6.238",
                        code: "2106-3",
                        display: "White",
                      },
                    },
                    {
                      url: "ombCategory",
                      valueCoding: {
                        system: "urn:oid:2.16.840.1.113883.6.238",
                        code: "1002-5",
                        display: "American Indian or Alaska Native",
                      },
                    },
                    {
                      url: "ombCategory",
                      valueCoding: {
                        system: "urn:oid:2.16.840.1.113883.6.238",
                        code: "2028-9",
                        display: "Asian",
                      },
                    },
                    {
                      url: "detailed",
                      valueCoding: {
                        system: "urn:oid:2.16.840.1.113883.6.238",
                        code: "1586-7",
                        display: "Shoshone",
                      },
                    },
                    {
                      url: "detailed",
                      valueCoding: {
                        system: "urn:oid:2.16.840.1.113883.6.238",
                        code: "2036-2",
                        display: "Filipino",
                      },
                    },
                    {
                      url: "text",
                      valueString: "Mixed",
                    },
                  ],
                },
              ];
              // console.dir(pt["extension"][0].url);
              let usCoreRaceUrl =
                "http://hl7.org/fhir/us/core/StructureDefinition/us-core-race";
              let extensionUsCoreRaceEntry = mixedRaceExample.find(
                (element) => element.url === usCoreRaceUrl
              );
              console.log(extensionUsCoreRaceEntry);
              console.log("race example: ");
              console.log(extensionUsCoreRaceEntry != undefined);
              extensionUsCoreRaceEntry = ethnicityExample.find(
                (element) => element.url === usCoreRaceUrl
              );
              let femaleAtBirth = {
                url: "http://hl7.org/fhir/us/core/StructureDefinition/us-core-birthsex",
                valueCode: "F",
              };
              let whiteRace = {
                url: "http://hl7.org/fhir/us/core/StructureDefinition/us-core-race",
                extension: [
                  {
                    url: "ombCategory",
                    valueCoding: {
                      system: "urn:oid:2.16.840.1.113883.6.238",
                      code: "2106-3",
                      display: "White",
                    },
                  },
                  {
                    url: "text",
                    valueString: "White",
                  },
                ],
              };
              if (pt.hasOwnProperty("extension")) {
                console.log("this patient resource has an extension");
                pt["extension"].push(whiteRace);
              } else {
                console.log("this patient resource does not have an extension");
                pt["extension"] = [whiteRace];
              }
              // smart.update(pt); DH
            },
            function (error) {
              document.getElementById("pt").innerText = error.stack;
            }
          );
        })
        .catch(console.error);
      // DH this form code is from https://www.dyn-web.com/tutorials/forms/radio/get-selected.php
      function getRadioVal(form, name) {
        var val;
        // get list of radio buttons with specified name
        var radios = form.elements[name];

        // loop through list of radio buttons
        for (var i = 0, len = radios.length; i < len; i++) {
          if (radios[i].checked) {
            // radio checked?
            val = radios[i].value; // if so, hold its value in val
            break; // and break out of for loop
          }
        }
        return val; // return value of checked radio or undefined if none checked
      }
      // get value of selected 'race' radio button in 'raceForm'
      var val = getRadioVal(document.getElementById("raceForm"), "race");
      alert(val);
    </script>
  </body>
</html>
